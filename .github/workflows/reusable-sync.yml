name: Reusable Sync Workflow

on:
  workflow_call:
    secrets:
      DEVELOPER_SETTINGS_TOKEN:
        required: true

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout source repo
        uses: actions/checkout@v4

      - name: Checkout developer-settings
        uses: actions/checkout@v4
        with:
          repository: insight-llc/developer-settings
          token: ${{ secrets.DEVELOPER_SETTINGS_TOKEN }}
          path: _developer-settings

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.4'

      - name: Extract tracked paths from config
        id: config
        run: |
          PATHS=$(php -r "
            \$config = require '_developer-settings/config/developer-settings.php';
            \$paths = array_merge(
              \$config['paths']['directories'] ?? [],
              \$config['paths']['files'] ?? []
            );
            echo implode(PHP_EOL, \$paths);
          ")
          echo "paths<<EOF" >> $GITHUB_OUTPUT
          echo "$PATHS" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Copy tracked files to package
        run: |
          TRACKED_PATHS="${{ steps.config.outputs.paths }}"

          while IFS= read -r tracked; do
            [ -z "$tracked" ] && continue
            if [ -d "$tracked" ]; then
              find "$tracked" -type f | while read -r file; do
                target="_developer-settings/$file"
                mkdir -p "$(dirname "$target")"
                cp "$file" "$target"
              done
            elif [ -f "$tracked" ]; then
              target="_developer-settings/$tracked"
              mkdir -p "$(dirname "$target")"
              cp "$tracked" "$target"
            fi
          done <<< "$TRACKED_PATHS"

      - name: Detect changes
        id: changes
        run: |
          cd _developer-settings
          MODIFIED=$(git diff --name-only)
          NEW=$(git ls-files --others --exclude-standard)
          ALL_CHANGED=$(echo -e "$MODIFIED\n$NEW" | sort -u | grep -v '^$' || true)

          if [ -n "$ALL_CHANGED" ]; then
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "files<<EOF" >> $GITHUB_OUTPUT
            echo "$ALL_CHANGED" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          fi

      - name: Create Pull Request
        if: steps.changes.outputs.has_changes == 'true'
        uses: peter-evans/create-pull-request@v6
        with:
          path: _developer-settings
          token: ${{ secrets.DEVELOPER_SETTINGS_TOKEN }}
          branch: sync/${{ github.repository_owner }}/${{ github.event.repository.name }}
          delete-branch: true
          title: "sync: Update from ${{ github.repository }}"
          body: |
            ## Automated Sync

            Changes to shared config files detected in `${{ github.repository }}`.

            **Changed files:**
            ```
            ${{ steps.changes.outputs.files }}
            ```

            **Source commit:** ${{ github.event.head_commit.url }}

            ---
            After merging, tag a new release to distribute changes.
          commit-message: "sync: Update from ${{ github.repository }}"
          labels: |
            automated
            sync
